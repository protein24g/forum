<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        @media (max-width: 768px) {
            /* 모바일 화면에서 제목 글꼴 크기 조정 */
            body{
                font-size : 10px;
            }
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function (){
            getUserDetail(0 );
        })

        function addEventToRows() {
            document.querySelectorAll("tbody tr").forEach(function (tr) { // tbody 내에 모든 tr 태그를 찾아서 for
                tr.querySelectorAll("td").forEach(function (td){ // tr 내에 모든 td 태그를 찾아서 px-0
                    td.classList.add("px-0");
                })
                tr.addEventListener("click", function (){ // tr 태그에 click 이 발생한다면
                    window.location.href = "/boards/" + tr.getAttribute("id"); // tr 태그에 있는 id 값을 더해 상세보기 페이지로 이동
                })
            })
        }

        // R(Read)
        async function getUserDetail(page){
            let userId = document.getElementById("userId").value;
            try{
                const response = await fetch(`/api/users/${userId}?page=${page}`, {
                    method : "GET",
                    headers : {
                        "Content-Type" : "application/json",
                    }
                });

                const res = await response.json();
                console.log(res);
                document.getElementById("nickname").innerText = res.nickname;
                document.getElementById("boards_count").innerText = "작성 글 : " + res.boards.totalElements + "개";

                let boardHtml = "";
                res.boards.content.forEach(row => {
                    let title = row.title;
                    if(title.length >= 10) title = title.slice(0,10) + "...";

                    let createDate = row.createDate.replace(/[T,-]/g, " ").slice(2,16);

                    boardHtml += `
                            <tr id=${row.id}>
                                <td>${row.id}</td>
                                <td>${row.view}</td>
                                <td>${row.nickname}</td>
                                <td>${createDate}</td>
                                <td>${title} [${row.commentCount}]</td>
                            </tr>
                        `;
                });

                let boardPageHtml = "";
                boardPageHtml += `
                            <li class="page-item ${(res.boards.first) ? "disabled" : ""}">
                                <a class="page-link" onclick="getUserDetail(${res.boards.number - 1})">Previous</a>
                            </li>
                            `;

                let startPage = (Math.floor((res.boards.number) / 10)) * 10;
                let endPage = Math.min(startPage + 10, res.boards.totalPages);
                for(let page = startPage; page < endPage ; page++){
                    console.log(startPage);
                    boardPageHtml += `
                                <li class="page-item ${(page == res.boards.number) ? 'active' : ''}">
                                    <a class="page-link" onclick="getUserDetail(${page})">${page + 1}</a>
                                </li>
                            `;
                }

                boardPageHtml += `
                            <li class="page-item ${(res.boards.last) ? "disabled" : ""}">
                                <a class="page-link" onclick="getUserDetail(${res.boards.number + 1})">Next</a>
                            </li>
                        `;

                document.querySelector(".board_page_list").innerHTML = boardPageHtml;

                let commentHtml = ``;

                res.comments.content.forEach(row => {
                    // 고유한 모달 ID 생성
                    commentHtml += `
                        <div class="row" onclick="window.location.href = '/boards/' + ${row.boardId}">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <img src="https://cdn-icons-png.flaticon.com/128/4530/4530959.png" class="img-fluid" width="35">
                                        </div>
                                        <div class="col">
                                            <span>${row.nickname}</span>
                                        </div>
                                        <div class="col">
                                            <span>|</span>
                                        </div>
                                        <div class="col"> <!-- 자동으로 남은 공간을 차지하게 함 -->
                                            <span>${row.createDate.replace('T', ' ').slice(0, 19)}</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <span>${row.content}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                });

                document.querySelector(".board_list").innerHTML = boardHtml;
                document.querySelector(".cm_list").innerHTML = commentHtml;
                addEventToRows();
            }catch (error){
                alert(error);
                window.location.href = "/";
            }
        }
    </script>
</head>
<body>
<input type="hidden" id="userId" th:value="${userId}">
<div class="container mt-5">
    <div class="p-3" style="background:darkgray">
        <div class="row">
            <!-- 사용자 이미지 -->
            <div class="col-2 text-center">
                <a href="/">
                    <img src="https://cdn-icons-png.flaticon.com/128/3917/3917033.png" class="img-fluid" alt="사용자 이미지">
                </a>
            </div>
            <!-- 닉네임과 작성한 글 수 -->
            <div class="col-8">
                <h3 id="nickname"></h3>
                <br>
                <p id="boards_count"></p>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">작성글</button>
            <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">댓글</button>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active"  id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0">
            <!--게시글 Detail-->
            <table class="table table-hover text-center">
                <thead class="table-light">
                <tr>
                    <th class="col">#</th>
                    <th class="col">조회수</th>
                    <th class="col">닉네임</th>
                    <th class="col">날짜</th>
                    <th class="col">제목</th>
                </tr>
                </thead>
                <tbody class="board_list">
                </tbody>
            </table>
            <!--게시글 페이징-->
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center page_list board_page_list">
                </ul>
            </nav>
        </div>
        <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
            <!--/* 댓글 렌더링 영역 */-->
            <div class="cm_list"></div>
            <!--댓글 페이징-->
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center page_list comment_page_list">
                </ul>
            </nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
